(window.webpackJsonp=window.webpackJsonp||[]).push([[116],{432:function(e,s,a){"use strict";a.r(s);var t=a(17),r=Object(t.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"设置及使用coredump文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设置及使用coredump文件"}},[e._v("#")]),e._v(" 设置及使用coredump文件")]),e._v(" "),s("h2",{attrs:{id:"coredump文件介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#coredump文件介绍"}},[e._v("#")]),e._v(" coredump文件介绍")]),e._v(" "),s("p",[e._v("核心转储是一个包含进程意外终止时进程内存内容的文件。核心转储由内核触发以响应程序崩溃。核心转储作为崩溃时程序状态的事后快照非常重要，特别是在故障难以重现的情况下。")]),e._v(" "),s("h2",{attrs:{id:"开启关闭核心转储core-dumps功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启关闭核心转储core-dumps功能"}},[e._v("#")]),e._v(" 开启关闭核心转储"),s("code",[e._v("core dumps")]),e._v("功能")]),e._v(" "),s("p",[e._v("核心转储功能是否开启可以使用命令"),s("code",[e._v("ulimit")]),e._v("查看")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("ulimit")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-a")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# core file size          (blocks, -c) 0")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# data seg size           (kbytes, -d) unlimited")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# scheduling priority             (-e) 0")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# file size               (blocks, -f) unlimited")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# pending signals                 (-i) 63207")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max locked memory       (kbytes, -l) 65536")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max memory size         (kbytes, -m) unlimited")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# open files                      (-n) 1024")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# pipe size            (512 bytes, -p) 8")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# POSIX message queues     (bytes, -q) 819200")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# real-time priority              (-r) 0")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# stack size              (kbytes, -s) 8192")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# cpu time               (seconds, -t) unlimited")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# max user processes              (-u) 63207")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# virtual memory          (kbytes, -v) unlimited")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# file locks                      (-x) unlimited")]),e._v("\n")])])]),s("p",[e._v("其中，"),s("code",[e._v("core file size (blocks, -c) 0")]),e._v("说明程序崩溃时不会生成"),s("code",[e._v("core")]),e._v("文件。")]),e._v(" "),s("h3",{attrs:{id:"开启核心转储生成功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启核心转储生成功能"}},[e._v("#")]),e._v(" 开启核心转储生成功能")]),e._v(" "),s("p",[e._v("转储文件的使能是通过命令"),s("code",[e._v("ulimit")]),e._v("控制的"),s("code",[e._v("soft limit")]),e._v("。通过如下命令可以临时开启生成转储文件：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("ulimit")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-S")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-c")]),e._v(" unlimited\n")])])]),s("p",[s("code",[e._v("-S")]),e._v("参数表示"),s("code",[e._v("soft limit")]),e._v("，"),s("code",[e._v("-c")]),e._v("表示的"),s("code",[e._v("coredumps")]),e._v("文件的大小限制。")]),e._v(" "),s("p",[e._v("如果想在当前系统设置永久生效，可以在"),s("code",[e._v("/etc/security/limits.conf")]),e._v("中添加如下配置行：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("* soft core unlimited\n")])])]),s("p",[e._v("默认情况下生成的"),s("code",[e._v("coredumps")]),e._v("文件由"),s("code",[e._v("apport")]),e._v("程序管理，因此要查找默认生成的"),s("code",[e._v("coredumps")]),e._v("文件路径，可以先查看"),s("code",[e._v("apport")]),e._v("程序日志：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" /var/log/apport.log\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ERROR: apport (pid 306149) Wed Apr 10 00:48:57 2024: executable does not belong to a package, ignoring")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ERROR: apport (pid 306149) Wed Apr 10 00:48:57 2024: writing core dump to core._media_xx_data_code_basic_cplusplus_examples_debug_leak.1000.47fbc564-8f91-46c4-9af5-1d77388becb8.306148.70162237 (limit: -1)")]),e._v("\n\n")])])]),s("p",[e._v("可以看到生成了"),s("code",[e._v("core._media_xx_data_code_basic_cplusplus_examples_debug_leak.1000.47fbc564-8f91-46c4-9af5-1d77388becb8.306148.70162237")]),e._v("文件，在"),s("code",[e._v("/var")]),e._v("路径下搜索发现：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("find")]),e._v(" ./ "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-name")]),e._v(" core._media_xx_data_code_basic_cplusplus_examples_debug_leak.1000.47fbc564-8f91-46c4-9af5-1d77388becb8.306148.70162237\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("sudo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" password "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" xx: \n./lib/apport/coredump/core._media_xx_data_code_basic_cplusplus_examples_debug_leak.1000.47fbc564-8f91-46c4-9af5-1d77388becb8.306148.70162237\n")])])]),s("p",[s("strong",[e._v("设置coredumps文件的生成路径")]),e._v("，上面是默认生成"),s("code",[e._v("coredumps")]),e._v("文件的路径，用户可以根据需要自己定制文件的路径：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sysctl")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-w")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("kernel.core_pattern")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/coredumps/core-%e-%s-%u-%g-%p-%t\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# will update content in `/proc/sys/kernel/core_pattern`")]),e._v("\n")])])]),s("p",[e._v("上面的命令是一次性的，只能控制当前环境中生成的"),s("code",[e._v("coredumps")]),e._v("文件位置，要想设置系统层面"),s("code",[e._v("coredumps")]),e._v("文件的生成路径，可以在文件"),s("code",[e._v("/etc/sysctl.conf")]),e._v("中添加一行如下内容:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("kernel.core_pattern")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/coredumps/core-%e-%s-%u-%g-%p-%t"')]),e._v("\n")])])]),s("p",[e._v("设置"),s("code",[e._v("core_pattern")]),e._v("时对应的符号含义：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %e  The process or thread's comm value, which typically is the")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#     same as the executable filename (without path prefix, and")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#     truncated to a maximum of 15 characters)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %i  TID of thread that triggered core dump, as seen in the PID")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#     namespace in which the thread resides.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %p  PID of dumped process, as seen in the PID namespace in which")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#     the process resides.")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %s  Number of signal causing dump.")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %%    单个%字符")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %p    所dump进程的进程ID")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %u    所dump进程的实际用户ID")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %g    所dump进程的实际组ID")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %s    导致本次core dump的信号")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %t    core dump的时间 (由1970年1月1日计起的秒数)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %h    主机名")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# %e    程序文件名")]),e._v("\n")])])]),s("p",[s("strong",[e._v("Attention")]),e._v(":这里需要注意的是在设置"),s("code",[e._v("core_pattern")]),e._v("时，需要确保指定的目录存在。不要设置在挂载的数据硬盘上，否则会导致"),s("code",[e._v("size")]),e._v("为"),s("code",[e._v("0``coredump")]),e._v("文件。"),s("code",[e._v("gdb")]),e._v("使用时会报错：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v('# core.leak-11-1000-1000-313132-1712684913" is not a core dump: file format not recognized')]),e._v("\n")])])]),s("h3",{attrs:{id:"关闭生成转储文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关闭生成转储文件"}},[e._v("#")]),e._v(" 关闭生成转储文件")]),e._v(" "),s("p",[e._v("通过命令控制：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("ulimit")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-S")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-c")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n")])])]),s("p",[e._v("持久化修改，在文件"),s("code",[e._v("/etc/security/limits.conf")]),e._v("中加入如下行：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("* soft core "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n* hard core "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n")])])]),s("h2",{attrs:{id:"coredumps文件的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#coredumps文件的使用"}},[e._v("#")]),e._v(" coredumps文件的使用")]),e._v(" "),s("p",[e._v("使用"),s("code",[e._v("gdb")]),e._v("调试程序：")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("gdb "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("test")]),e._v(" coredumps_file\n\ninfo signals "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 查看导致`coredump`的信号")]),e._v("\n")])])]),s("h3",{attrs:{id:"查看core进程的所有线程堆栈"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看core进程的所有线程堆栈"}},[e._v("#")]),e._v(" 查看core进程的所有线程堆栈")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("查看所有线程正在运行的指令信息")])])]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("info threads\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#   Id   Target Id         Frame ")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# * 1    LWP 354754        __GI___libc_free (mem=0x4) at malloc.c:3102")]),e._v("\n")])])]),s("ul",[s("li",[s("strong",[e._v("打开所有线程的堆栈信息")])])]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("thread apply all bt\n")])])]),s("ul",[s("li",[s("strong",[e._v("查看指定线程堆栈信息")])])]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("thread apply "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("Id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" bt\n\n")])])]),s("h3",{attrs:{id:"release版本发布时的调试方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#release版本发布时的调试方法"}},[e._v("#")]),e._v(" release版本发布时的调试方法")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("bt "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# back trace information")]),e._v("\nb main "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# set break point at main")]),e._v("\nr "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# run the program")]),e._v("\nlist "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# see the file")]),e._v("\nlayout asm\nnexti\nstepi\n")])])]),s("h3",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[e._v("#")]),e._v(" reference")]),e._v(" "),s("blockquote",[s("p",[e._v("1"),s("a",{attrs:{href:"https://medium.com/@sourabhedake/core-dumps-how-to-enable-them-73856a437711",target:"_blank",rel:"noopener noreferrer"}},[e._v(".https://medium.com/@sourabhedake/core-dumps-how-to-enable-them-73856a437711"),s("OutboundLink")],1),s("br"),e._v("\n2"),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/46605905",target:"_blank",rel:"noopener noreferrer"}},[e._v(".https://zhuanlan.zhihu.com/p/46605905"),s("OutboundLink")],1),s("br"),e._v("\n3"),s("a",{attrs:{href:"https://stackoverflow.com/questions/13403824/empty-core-dump-file-after-segmentation-fault",target:"_blank",rel:"noopener noreferrer"}},[e._v(".https://stackoverflow.com/questions/13403824/empty-core-dump-file-after-segmentation-fault"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);