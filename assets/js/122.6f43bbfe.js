(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{438:function(t,s,a){"use strict";a.r(s);var n=a(17),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"externc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#externc"}},[t._v("#")]),t._v(" externC")]),t._v(" "),s("h2",{attrs:{id:"_1-为什么要使用externc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么要使用externc"}},[t._v("#")]),t._v(" 1.为什么要使用externC")]),t._v(" "),s("p",[t._v("一句话总结，C++支持函数重载，C语言不支持函数重载，在生成的C++编译文件中函数名会根据参数进行混淆(mangle)，而C语言的编译文件不会被混淆，所以在C++程序中链接C语言的函数动态库时需要使用externC来保证函数签名的正确性。")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// main.cpp")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("f")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("g")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extern")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"C"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("eg")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Prevent g and eg from being optimized away. */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("h")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("g")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("eg")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("如上代码，使用命令编译后查看目标文件符号：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("g++ "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-std")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("c++11 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-Wall")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-Wextra")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-pedantic")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" main.o main.cpp\nreadelf "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" main.o\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Symbol table '.symtab' contains 13 entries:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    Num:    Value          Size Type    Bind   Vis      Ndx Name")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS test_externC.cc")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      5: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      7: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      8: 0000000000000000     7 FUNC    GLOBAL DEFAULT    1 _Z1fv")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      9: 0000000000000007     7 FUNC    GLOBAL DEFAULT    1 ef")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     10: 000000000000000e    17 FUNC    GLOBAL DEFAULT    1 _Z1hv")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _Z1gv")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     12: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND eg")]),t._v("\n")])])]),s("p",[t._v("可以看到被"),s("code",[t._v('extern "C"')]),t._v("修饰的函数"),s("code",[t._v("ef/gf")]),t._v("函数名没有被混淆"),s("code",[t._v("mangle")]),t._v("，而未被函数名包围的按C++的编译规则被混淆了。")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("c++filt _Z1fv")]),t._v("命令可以反混淆(unmangle)函数名称，会发现"),s("code",[t._v("_Z1fv/_Z1hv/_Z1gv")]),t._v("对应的就是"),s("code",[t._v("f/g/h")])]),t._v(" "),s("p",[s("code",[t._v("c++filt")]),t._v("是一个用于解码（反编译）低级别的"),s("code",[t._v("C++")]),t._v("和"),s("code",[t._v("Java")]),t._v("符号名称的工具,用于将修饰后的函数名映射回源函数名。")]),t._v(" "),s("h2",{attrs:{id:"使用externc的一个例子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用externc的一个例子"}},[t._v("#")]),t._v(" 使用externC的一个例子")]),t._v(" "),s("p",[t._v("先创建一个"),s("code",[t._v("C")]),t._v("语言的"),s("code",[t._v("so")]),t._v("库：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// add.h")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// add.c")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<add.h>")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 编译成so库")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// gcc -fPIC -shared add.c -o libadd.so")]),t._v("\n")])])]),s("p",[t._v("通过上面的方式编译的"),s("code",[t._v("so")]),t._v("文件中存在的函数符号名为"),s("code",[t._v("add")]),t._v("，不包含参数名称修饰，因此无法直接被"),s("code",[t._v("c++")]),t._v("程序链接")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// main.cc")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<add.h>")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extern")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"C"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" argc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" j "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%d\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// gcc main.cc -o et -I ./ -L ./ -ladd")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 报错")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// /usr/bin/ld: /tmp/ccxcRKM6.o: in function `main':")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// main.cc:(.text+0x2f): undefined reference to `add(int, int)'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// collect2: error: ld returned 1 exit status")]),t._v("\n")])])]),s("p",[t._v("要想在"),s("code",[t._v("c++")]),t._v("中使用"),s("code",[t._v("C")]),t._v("语言编译的库，需要在"),s("code",[t._v("C")]),t._v("语言库的头文件中告诉"),s("code",[t._v("C++")]),t._v("哪些代码需要使用"),s("code",[t._v("C")]),t._v("的方式来编译，上面例子将"),s("code",[t._v("add.h")]),t._v("文件改成如下格式即可：")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// add.h")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[t._v("__cplusplus")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extern")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"C"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[t._v("__cplusplus")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n")])])]),s("p",[t._v("如此就能正常编译运行了。")]),t._v(" "),s("h3",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" reference")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://www.geeksforgeeks.org/extern-c-in-c/",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.https://www.geeksforgeeks.org/extern-c-in-c/"),s("OutboundLink")],1),s("br"),t._v(" "),s("a",{attrs:{href:"https://stackoverflow.com/questions/1041866/what-is-the-effect-of-extern-c-in-c",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.https://stackoverflow.com/questions/1041866/what-is-the-effect-of-extern-c-in-c"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);