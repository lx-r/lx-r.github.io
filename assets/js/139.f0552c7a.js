(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{455:function(t,e,a){"use strict";a.r(e);var s=a(17),r=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"perf工具使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#perf工具使用"}},[t._v("#")]),t._v(" perf工具使用")]),t._v(" "),e("h2",{attrs:{id:"基本介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本介绍"}},[t._v("#")]),t._v(" 基本介绍")]),t._v(" "),e("p",[e("code",[t._v("Perf（Performance Counters for Linux，性能计数器子系统）")]),t._v("是一个"),e("code",[t._v("Linux")]),t._v("性能分析工具，用于分析系统和应用程序的运行时性能。"),e("strong",[t._v("这个工具位于 "),e("code",[t._v("Linux")]),t._v(" 内核源代码树中，具体位置在 "),e("code",[t._v("tools/perf")]),t._v(" 目录下。虽然它是一个用户空间的应用程序，但却是唯一一个被包含在 "),e("code",[t._v("Linux")]),t._v(" 内核源码中的复杂用户软件。")])]),t._v(" "),e("p",[e("code",[t._v("Perf")]),t._v("可以帮助开发人员和系统管理员进行函数级和指令级的热点查找，可以用来分析程序中热点函数的"),e("code",[t._v("CPU")]),t._v("占用率，了解"),e("code",[t._v("CPU")]),t._v("性能计数器、内核跟踪点和硬件事件等信息，从而找到性能瓶颈，优化软件性能并诊断问题。")]),t._v(" "),e("p",[t._v("通过 "),e("code",[t._v("perf")]),t._v(" 命令，我们可以获得系统在运行过程中的各种性能数据，例如 "),e("code",[t._v("CPU")]),t._v(" 利用率、内存使用情况、磁盘 "),e("code",[t._v("I/O")]),t._v(" 等。"),e("code",[t._v("perf")]),t._v(" 可以用于多个方面的性能分析，以下是一些常用的用途：")]),t._v(" "),e("ul",[e("li",[e("strong",[e("code",[t._v("CPU")]),t._v(" 性能分析")]),t._v("，通过 "),e("code",[t._v("perf")]),t._v("命令，可以监测 "),e("code",[t._v("CPU")]),t._v(" 的使用率、上下文切换次数、缓存命中率等指标，可以帮助开发者找出 "),e("code",[t._v("CPU")]),t._v(" 性能瓶颈，优化程序的运行效率。")]),t._v(" "),e("li",[e("strong",[t._v("内存性能分析")]),t._v("，"),e("code",[t._v("perf")]),t._v(" 命令可以监测内存的使用情况，例如内存泄漏、内存碎片等问题，可以帮助开发者优化内存的管理，提高系统的稳定性。")]),t._v(" "),e("li",[e("strong",[t._v("函数级别采样")]),t._v("，"),e("code",[t._v("perf")]),t._v("可以对程序进行函数级别的采样，从而了解程序的性能瓶颈在哪里。其基本原理是每隔一个固定时间，"),e("code",[t._v("CPU")]),t._v(" 会产生一个中断，记录当前是哪个进程、哪个函数，然后给对应的进程和函数加一个统计值，从而知道 "),e("code",[t._v("CPU")]),t._v(" 在某个进程或某个函数上花费了多少时间。")])]),t._v(" "),e("p",[t._v("如果系统没有安装"),e("code",[t._v("Perf")]),t._v("，安装方式为：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" linux-tools-common linux-tools-generic\n")])])]),e("p",[t._v("查看是否安装成功:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("perf "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--version")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# perf version 5.15.148")]),t._v("\n")])])]),e("p",[t._v("权限设置，默认运行"),e("code",[t._v("perf")]),t._v("命令需要"),e("code",[t._v("sudo")]),t._v("权限，可以通过修改"),e("code",[t._v("/etc/sysctt.conf")]),t._v("文件进行设置")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/sysctl.conf\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# add line")]),t._v("\nkernel.perf_event_paranoid "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),e("h2",{attrs:{id:"perf命令使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#perf命令使用"}},[t._v("#")]),t._v(" "),e("code",[t._v("perf")]),t._v("命令使用")]),t._v(" "),e("p",[t._v("命令格式为：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("perf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("options"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" subcommand "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("options/arguments"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("p",[e("code",[t._v("perf")]),t._v("支持很多"),e("code",[t._v("subcommand")]),t._v("选项，常用的子命令有：")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("annotate")]),t._v("读取"),e("code",[t._v("perf.data")]),t._v("，展示带注释代码，实际使用发现展示的汇编代码")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf annotate "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Percent│       xor    %r15d,%r15d")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       lea    0x9(%rsp),%rbp")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       testb  $0x3,0x90(%rsp)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │     ↓ je     96")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       swapgs")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       nop")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       xchg   %ax,%ax")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       mov    %cr3,%rax")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       bts    $0x3f,%rax")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       and    $0xffffffffffffe7ff,%rax")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       mov    %rax,%cr3")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       xchg   %ax,%ax")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        │       mov    $0x48,%ecx")]),t._v("\n")])])]),e("ul",[e("li",[e("code",[t._v("list")]),t._v("，展示"),e("code",[t._v("perf")]),t._v("命令可以用来评估程序性能的事件")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf list "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Usage: perf list [<options>] [hw|sw|cache|tracepoint|pmu|sdt|metric|metricgroup|event_glob]")]),t._v("\n")])])]),e("p",[t._v("通过上面的命令可以查看事件类型，"),e("code",[t._v("hw")]),t._v("是"),e("code",[t._v("hardware")]),t._v("硬件相关事件，"),e("code",[t._v("PMU")]),t._v("是"),e("code",[t._v("Performance Monitoring Unit")]),t._v("相关事件等")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("record")]),t._v("，记录程序运行时的数据")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf record "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" cpu-clock "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-aR")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# [ perf record: Woken up 1 times to write data ]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# [ perf record: Captured and wrote 0.002 MB perf.data (~150 samples) ]")]),t._v("\n")])])]),e("ul",[e("li",[e("code",[t._v("report")]),t._v("，展示"),e("code",[t._v("perf")]),t._v("命令记录的数据")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf report "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" perf.data\n")])])]),e("ul",[e("li",[e("code",[t._v("stat")]),t._v("查看具体某个事件相关的统计结果")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("stat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" cpu-clock "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-aR")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  Performance counter stats for 'sleep 10':")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#               1.13 msec cpu-clock                 #    0.000 CPUs utilized          ")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#       10.002228914 seconds time elapsed")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        0.001793000 seconds user")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        0.000000000 seconds sys")]),t._v("\n\n")])])]),e("p",[e("code",[t._v("stat")]),t._v("和"),e("code",[t._v("record")]),t._v("子命令的主要区别是"),e("code",[t._v("record")]),t._v("会将结果保存到"),e("code",[t._v("perf.data")]),t._v("文件中，而"),e("code",[t._v("stat")]),t._v("是直接展示结果。")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("top")]),t._v("是直接展示整个系统的"),e("code",[t._v("CPU")]),t._v("内存等使用情况")]),t._v(" "),e("li",[e("code",[t._v("script")]),t._v("读取"),e("code",[t._v("perf.data")]),t._v("数据，并展示迹输出"),e("code",[t._v("trace out")])])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("子命令")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("作用")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("annotate")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("汇编代码及注释")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("list")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("查看所有事件")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("stat")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("查看某事件相关的性能数据")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("record")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("录制某事件相关的性能数据，并保存"),e("code",[t._v("perf.data")]),t._v("文件")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("report")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("加载"),e("code",[t._v("perf.data")]),t._v("文件")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("top")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("系统相关的性能数据")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("script")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("perf.data")]),t._v("相关的"),e("code",[t._v("trace out")])])])])]),t._v(" "),e("p",[t._v("使用"),e("code",[t._v("perf")]),t._v("命令追踪一个正在运行的进程:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" perf "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("stat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--pid")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("pid"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("h3",{attrs:{id:"reference"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" reference")]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://phoenixnap.com/kb/linux-perf#:~:text=The%20Linux%20perf%20tool%20is,and%20analyzing%20CPU%20event%20data.",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.https://phoenixnap.com/kb/linux-perf#:~:text=The%20Linux%20perf%20tool%20is,and%20analyzing%20CPU%20event%20data."),e("OutboundLink")],1),e("br"),t._v(" "),e("a",{attrs:{href:"https://cloud.tencent.com/developer/article/2228048",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.https://cloud.tencent.com/developer/article/2228048"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);