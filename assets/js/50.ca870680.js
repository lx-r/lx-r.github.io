(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{368:function(t,a,s){"use strict";s.r(a);var _=s(17),e=Object(_.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"yolov2训练时anchor是如何使用的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#yolov2训练时anchor是如何使用的"}},[t._v("#")]),t._v(" Yolov2训练时anchor是如何使用的")]),t._v(" "),a("h2",{attrs:{id:"_0-简略描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-简略描述"}},[t._v("#")]),t._v(" 0.简略描述")]),t._v(" "),a("ul",[a("li",[t._v("1.将真值检测框变换到特征图尺度上")]),t._v(" "),a("li",[t._v("2.计算以特征图每个网格中心为中心点时所有锚框与真值检测框的交并比")]),t._v(" "),a("li",[t._v("3.取与真值检测框交并比最大的锚框的id,及真值检测框中心所在cell的id,有此，可将真值检测框与预测结果对应起来")]),t._v(" "),a("li",[t._v("4.计算位置回归损失，置信度损失，分类损失")])]),t._v(" "),a("h2",{attrs:{id:"_1-网络的输出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-网络的输出"}},[t._v("#")]),t._v(" 1.网络的输出")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolov2-anchors.jpg",alt:""}}),a("br"),t._v("\nyolov2 网络对于检测框位置大小的输出是:"),a("br"),t._v(" "),a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/txtytwth.jpg",alt:""}}),a("br"),t._v("\n对于1个batch网络的输出的"),a("code",[t._v("shape")]),t._v("为"),a("code",[t._v("[batch_size, H*W*num_anchors, 5+num_classes]")]),t._v(", 其中：")]),t._v(" "),a("ul",[a("li",[t._v("num_anchors：指1个点处的anchor数量")]),t._v(" "),a("li",[t._v("H，W分别是卷积得到的feature map的高宽")]),t._v(" "),a("li",[t._v("5 + num_classes,分别指{% mathjax %}"),a("br"),t._v("\nt_x"),a("br"),t._v("\n{% endmathjax %} 、{% mathjax %}t_y{% endmathjax %}、{% mathjax %}t_\\omega{% endmathjax %}、{% mathjax %}t_h{% endmathjax %}及检测框的评分"),a("code",[t._v("score")])])]),t._v(" "),a("h2",{attrs:{id:"_2-输出的处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-输出的处理"}},[t._v("#")]),t._v(" 2.输出的处理")]),t._v(" "),a("p",[t._v("拿到网络的输出后，使用"),a("code",[t._v("图1")]),t._v("中的公式计算得到{% mathjax %}\\sigma(t_x),\\sigma(t_y),e^{t_\\omega},e^{t_h}{% endmathjax %},再分别得到feature_map尺度上的所有{% mathjax %}c_x,c_y{% endmathjax %}，根据不同"),a("code",[t._v("anchors")]),t._v("计算得每个预测点对应的检测框如下图："),a("br"),t._v(" "),a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/ya1.jpg",alt:""}}),a("br"),t._v("\n裁切去超出的部分："),a("br"),t._v(" "),a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/ya2.jpg",alt:""}}),a("br"),t._v("\n其中，"),a("code",[t._v("pa11、pa21、pa31")]),t._v("即在"),a("code",[t._v("2x2")]),t._v("的"),a("code",[t._v("feature_map")]),t._v("上的中心点落在"),a("code",[t._v("cell1")]),t._v("时对应的预测框，在本例中"),a("code",[t._v("feature_map")]),t._v("的"),a("code",[t._v("H、W")]),t._v("都为"),a("code",[t._v("2")]),t._v(",每个"),a("code",[t._v("cell")]),t._v("上分别有不同尺度的"),a("code",[t._v("anchor")]),t._v("3个，由此可得1张图像上的检测框共有"),a("code",[t._v("HxWxnum_anchors")]),t._v("个。")]),t._v(" "),a("h2",{attrs:{id:"_3-端到端训练loss的计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-端到端训练loss的计算"}},[t._v("#")]),t._v(" 3.端到端训练loss的计算")]),t._v(" "),a("p",[t._v("同"),a("code",[t._v("#1")]),t._v(","),a("code",[t._v("#2")]),t._v("中所讲，网络输出的"),a("code",[t._v("shape")]),t._v("为"),a("code",[t._v("[batch_size,H*W*num_anchors, 5+num_classes]")]),t._v(",输出的内容是{% mathjax %}t_x,t_y,t_\\omega,t_h,score,class_score{% endmathjax %}, "),a("code",[t._v("yolov2")]),t._v("的"),a("code",[t._v("loss")]),t._v("函数有"),a("code",[t._v("3")]),t._v("部分构成：")]),t._v(" "),a("p",[t._v("{% mathjax %}loss = loss_{coordination}+loss_{confidence}+loss_{classification}{% endmathjax %}")]),t._v(" "),a("p",[t._v("代码示例：")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("    box_loss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" cfg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("coord_scale "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" F"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mse_loss"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delta_pred_batch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" box_mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" box_target "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" box_mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reduction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sum'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("\n    iou_loss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" F"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mse_loss"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("conf_pred_batch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" iou_mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" iou_target "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" iou_mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reduction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sum'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("\n    class_loss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" cfg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("class_scale "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" F"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cross_entropy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("class_score_batch_keep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" class_target_keep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reduction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sum'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/ya3.jpg",alt:""}}),a("br"),t._v("\n这里比较关键的一点，网络的输出是"),a("code",[t._v("H*W*num_anchors")]),t._v("个预测结果，且预测的"),a("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[a("mjx-math",{staticClass:"MJX-TEX"},[a("mjx-msub",[a("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[a("mjx-c",{attrs:{c:"t"}})],1),a("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{size:"s"}},[a("mjx-c",{attrs:{c:"x"}})],1)],1)],1),a("mjx-mo",{staticClass:"mjx-n"},[a("mjx-c",{attrs:{c:","}})],1),a("mjx-msub",{attrs:{space:"2"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[a("mjx-c",{attrs:{c:"t"}})],1),a("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{size:"s"}},[a("mjx-c",{attrs:{c:"y"}})],1)],1)],1),a("mjx-mo",{staticClass:"mjx-n"},[a("mjx-c",{attrs:{c:","}})],1),a("mjx-msub",{attrs:{space:"2"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[a("mjx-c",{attrs:{c:"t"}})],1),a("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{size:"s"}},[a("mjx-c",{attrs:{c:"3C9"}})],1)],1)],1),a("mjx-mo",{staticClass:"mjx-n"},[a("mjx-c",{attrs:{c:","}})],1),a("mjx-msub",{attrs:{space:"2"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[a("mjx-c",{attrs:{c:"t"}})],1),a("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[a("mjx-mi",{staticClass:"mjx-i",attrs:{size:"s"}},[a("mjx-c",{attrs:{c:"h"}})],1)],1)],1)],1)],1),t._v("还只是预测框相对于"),a("code",[t._v("anchor")]),t._v("锚框的的偏移量。检测训练数据中，标签文件是"),a("code",[t._v("ground truth box")]),t._v("的中心点和宽高归一化后的坐标，且"),a("code",[t._v("ground truth box(gt box)")]),t._v("的数量远小于预测数"),a("code",[t._v("H*W*num_anchors")]),t._v("，如何将"),a("code",[t._v("gtbox")]),t._v("与预测的结果对应起来呢？如上图，如何确定是"),a("code",[t._v("cell1")]),t._v("中的"),a("code",[t._v("pa11")]),t._v("负责预测图中的小人呢？这里有个"),a("code",[t._v("anchor assignment")]),t._v("的过程，在"),a("code",[t._v("yolo")]),t._v("源码中有一个函数"),a("code",[t._v("build_target")]),t._v("正是处理"),a("code",[t._v("gt box")]),t._v("与预测结果之间的对应。")],1),t._v(" "),a("p",[t._v("其映射过程如下，首先将"),a("code",[t._v("gt box")]),t._v("和"),a("code",[t._v("anchor")]),t._v("都乘上"),a("code",[t._v("[W,H]")]),t._v("变换到"),a("code",[t._v("feature map")]),t._v("尺度上，计算可得"),a("code",[t._v("gt box")]),t._v("与"),a("code",[t._v("H*W*num_anchors")]),t._v("个"),a("code",[t._v("anchor")]),t._v("锚框之间的"),a("code",[t._v("IOU")]),t._v(",计算"),a("code",[t._v("gt_box")]),t._v("与"),a("code",[t._v("anchors")]),t._v("之间的"),a("code",[t._v("IOU")]),t._v("时分别取特征图每个"),a("code",[t._v("cell")]),t._v("的中心，得")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("overlaps = box_ious(all_anchors_xxyy, gt_boxes).view(-1, num_anchors, num_obj)\n")])])]),a("p",[t._v("然后确定"),a("code",[t._v("gt box")]),t._v("中心落在"),a("code",[t._v("feature map")]),t._v("哪个"),a("code",[t._v("cell")]),t._v("中，根据{% mathjax %}c_x,c_y{% endmathjax %}可求得：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("cell_idx_x, cell_idx_y = torch.floor(gt_box_xywh[:2])\n")])])]),a("p",[t._v("据此求得"),a("code",[t._v("gt box")]),t._v("的中心在哪个"),a("code",[t._v("cell")]),t._v(",结合上面已求出的"),a("code",[t._v("IOU")]),t._v("得到每个"),a("code",[t._v("gt box")]),t._v("与该"),a("code",[t._v("cell")]),t._v("中每个"),a("code",[t._v("anchor")]),t._v("的"),a("code",[t._v("IOU")]),t._v(",其最大者即负责预测当前"),a("code",[t._v("gt_box")])]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("cell_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cell_idx_x"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("W"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("cell_idx_y\noverlaps_in_cell "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" overlaps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("cell_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nargmax_anchor_idx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argmax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("overlaps_in_cell"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/ya4.jpg",alt:""}}),a("br"),t._v("\n上图中，"),a("code",[t._v("gt_box")]),t._v("时检测小人的检测框，其中心落在"),a("code",[t._v("cell1")]),t._v("中，且计算可知其与"),a("code",[t._v("anchor")]),t._v("锚框"),a("code",[t._v("ta11")]),t._v("的"),a("code",[t._v("IOU")]),t._v("最大，故"),a("code",[t._v("cell1")]),t._v("中的"),a("code",[t._v("ta11")]),t._v("负责预测"),a("code",[t._v("gt_box")]),t._v("。"),a("br"),t._v("\n找到"),a("code",[t._v("gt box")]),t._v("对应的"),a("code",[t._v("cell")]),t._v("和"),a("code",[t._v("anchor")]),t._v("后可根据"),a("code",[t._v("图1")]),t._v("反向计算得真值偏移量用以计算"),a("code",[t._v("loss")]),t._v("，在"),a("code",[t._v("shape")]),t._v("为"),a("code",[t._v("[batch_size, H*W*num_anchors,5+num_class]")]),t._v("的预测中除"),a("code",[t._v("cell_id,argmax_anchor_idx")]),t._v("对应的预测框外，其他对预测结果无用，边框回归和分类评估时都直接忽略(使用mask=0抑制)，计算"),a("code",[t._v("confidence")]),t._v("将其目标计为"),a("code",[t._v("0")]),t._v("。")]),t._v(" "),a("InArticleAdsense",{attrs:{"data-ad-client":"ca-pub-8685746128991385","data-ad-slot":"2974191661"}}),t._v(" "),a("h3",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("blockquote",[a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/tztztztztz/yolov2.pytorch.git",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.https://github.com/tztztztztz/yolov2.pytorch.git"),a("OutboundLink")],1)])])])],1)}),[],!1,null,null,null);a.default=e.exports}}]);