(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{381:function(t,s,n){"use strict";n.r(s);var a=n(17),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"yolov8的ncnn模型导出与部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#yolov8的ncnn模型导出与部署"}},[t._v("#")]),t._v(" Yolov8的NCNN模型导出与部署")]),t._v(" "),s("h2",{attrs:{id:"_1-yolov8导出ncnn模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-yolov8导出ncnn模型"}},[t._v("#")]),t._v(" 1."),s("code",[t._v("yolov8")]),t._v("导出"),s("code",[t._v("ncnn")]),t._v("模型")]),t._v(" "),s("h3",{attrs:{id:"_1-ultralytics直接导出ncnn模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-ultralytics直接导出ncnn模型"}},[t._v("#")]),t._v(" 1)."),s("code",[t._v("ultralytics")]),t._v("直接导出"),s("code",[t._v("ncnn")]),t._v("模型")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" ultralytics "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" YOLO\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create a model")]),t._v("\nmodel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" YOLO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/xx/data/code/ultralytics/yolov8n-pose.pt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Export the model to NCNN with arguments")]),t._v("\nmodel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ncnn'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" half"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" imgsz"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("480")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("执行上面的代码，会在当前路径创建"),s("code",[t._v("yolov8n-pose_ncnn_model")]),t._v("文件夹:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n├── metadata.yaml\n├── model.ncnn.bin\n├── model.ncnn.param\n└── model_ncnn.py\n")])])]),s("p",[s("code",[t._v("model_ncnn.py")]),t._v("是"),s("code",[t._v("ncnn")]),t._v("模型推理的测试文件，可以直接执行测试导出的模型是否能正常工作。")]),t._v(" "),s("p",[t._v("不过"),s("code",[t._v("ultralytics")]),t._v("是使用"),s("a",{attrs:{href:"https://github.com/pnnx/pnnx",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("pnnx")]),s("OutboundLink")],1),t._v("导出的"),s("code",[t._v("ncnn")]),t._v("模型，使用"),s("code",[t._v("c++")]),t._v("导入，")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("auto")]),t._v(" net_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" std"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),s("span",{pre:!0,attrs:{class:"token generic-function"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make_unique")]),s("span",{pre:!0,attrs:{class:"token generic class-name"}},[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ncnn"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("Net"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("net_"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_param")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("param_file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("net_"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_model")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bin_file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_2-ultralytics导出onnx模型再转ncnn模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-ultralytics导出onnx模型再转ncnn模型"}},[t._v("#")]),t._v(" 2)."),s("code",[t._v("ultralytics")]),t._v("导出"),s("code",[t._v("onnx")]),t._v("模型再转"),s("code",[t._v("ncnn")]),t._v("模型")]),t._v(" "),s("blockquote",[s("p",[t._v("step1:"),s("code",[t._v("ultralytics")]),t._v("导出"),s("code",[t._v("onnx")]),t._v("模型")])]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" ultralytics "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" YOLO\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create a model")]),t._v("\nmodel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" YOLO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/xx/data/code/ultralytics/yolov8n-pose.pt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Export the model to NCNN with arguments")]),t._v("\nmodel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ncnn'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" half"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" imgsz"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("480")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("step2:简化"),s("code",[t._v("onnx")]),t._v("模型")])]),t._v(" "),s("p",[t._v("直接导出的"),s("code",[t._v("onnx")]),t._v("模型包含的"),s("code",[t._v("Gather/Shape")]),t._v("算子，在"),s("code",[t._v("ncnn")]),t._v("中并不支持，直接转换会失败，可以先使用"),s("code",[t._v("onnxsim")]),t._v("工具对"),s("code",[t._v("onnx")]),t._v("模型进行简化。 "),s("br")]),t._v(" "),s("p",[t._v("安装"),s("code",[t._v("onnxsim")]),t._v("包：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("pip3 install "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("U pip "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" pip3 install onnxsim\n")])])]),s("p",[t._v("使用：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("onnxsim yolov8n-pose.onnx yolov8n-pose-sim.onnx\n")])])]),s("p",[t._v("输出:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("Here is the difference:\n┏━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓\n┃            ┃ Original Model ┃ Simplified Model ┃\n┡━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩\n│ Add        │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("                │\n│ Concat     │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("               │\n│ Constant   │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("166")]),t._v("            │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("159")]),t._v("              │\n│ Conv       │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("73")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("73")]),t._v("               │\n│ Div        │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("                │\n│ Identity   │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("                │\n│ MaxPool    │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("                │\n│ Mul        │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("66")]),t._v("               │\n│ Reshape    │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("               │\n│ Resize     │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("                │\n│ Sigmoid    │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")]),t._v("               │\n│ Slice      │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("                │\n│ Softmax    │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("                │\n│ Split      │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("             │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("               │\n│ Sub        │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("                │\n│ Transpose  │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("              │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("                │\n│ Model Size │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(".7MiB        │ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(".7MiB          │\n└────────────┴────────────────┴──────────────────┘\n")])])]),s("blockquote",[s("p",[t._v("step3:使用"),s("code",[t._v("onnx2ncnn")]),t._v("将"),s("code",[t._v("onnx")]),t._v("模型转换为"),s("code",[t._v("ncnn")]),t._v("模型")])]),t._v(" "),s("p",[t._v("安装"),s("code",[t._v("ncnn")]),t._v("，在"),s("a",{attrs:{href:"https://github.com/Tencent/ncnn",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("ncnn")]),s("OutboundLink")],1),t._v("仓库下载"),s("code",[t._v("ncnn")]),t._v(",可以下载对应平台已编译好的包，也可以自己编译，解压后在"),s("code",[t._v("bin")]),t._v("路径下有我们要使用的可执行文件"),s("code",[t._v("onnx2ncnn")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("Usage: ./onnx2ncnn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("onnxpb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ncnnparam"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ncnnbin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("转优化模型，")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("ncnnoptimize mobilenet.param mobilenet.bin mobilenet-opt.param mobilenet-opt.bin "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65536")]),t._v(" \n")])])]),s("p",[t._v("转二进制模型:")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("Usage: ./ncnn2mem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ncnnproto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ncnnbin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idcpppath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("memcpppath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# like")]),t._v("\n./ncnn2mem mobilenet.param mobilenet.bin mobilenet.id.h mobilenet.mem.h\n")])])]),s("p",[t._v("使用二进制文件：")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<net.h>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<mobilenet.id.h>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("mobilenet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("h")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inference")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("auto")]),t._v(" net "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ncnn"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Net")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    net"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_param")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model_ncnn_param_bin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    net"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("load_model")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model_ncnn_bin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// extract content")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("auto")]),t._v(" ex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" net"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_extractor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ncnn"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("Mat x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("input")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model_ncnn_param_id"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("BLOB_in0 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("x"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ncnn"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("Mat out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("extract")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model_ncnn_param_id"),s("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("BLOB_out0 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("以上就可以实现导出并部署"),s("code",[t._v("yolov8")]),t._v("的"),s("code",[t._v("ncnn")]),t._v("模型了。下面来看下"),s("code",[t._v("yolov8")]),t._v("模型的"),s("code",[t._v("inference")]),t._v("过程。")]),t._v(" "),s("h2",{attrs:{id:"_2-yolov8关键点检测的推理过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-yolov8关键点检测的推理过程"}},[t._v("#")]),t._v(" 2."),s("code",[t._v("yolov8")]),t._v("关键点检测的推理过程")]),t._v(" "),s("h3",{attrs:{id:"检测框推理过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检测框推理过程"}},[t._v("#")]),t._v(" 检测框推理过程")]),t._v(" "),s("p",[s("code",[t._v("yolov8")]),t._v("和"),s("code",[t._v("yolov5")]),t._v("基本架构是相同的，都是"),s("code",[t._v("backbone")]),t._v("输出"),s("code",[t._v("P3, P4, P5")]),t._v("三级特征图, 主要的区别体现在针对关键点，实例分割，目标检测任务使用的输出头的不同。"),s("code",[t._v("yolov8")]),t._v("检测框的预测方式和"),s("code",[t._v("yolov5")]),t._v("有很大的不同。")]),t._v(" "),s("p",[s("code",[t._v("yolov8")]),t._v("中使用的检测框预测方式和"),s("code",[t._v("Nanodet/FCOS")]),t._v("算法中相似，都是一种"),s("code",[t._v("anchor free")]),t._v("的方式，不需要人工筛选锚框。"),s("code",[t._v("yolov8")]),t._v("还使用了"),s("code",[t._v("Generalized Focal Loss")]),t._v("，只需要设置超参数"),s("code",[t._v("reg_max")]),t._v("，默认为"),s("code",[t._v("16")]),t._v(",然后对特征做"),s("code",[t._v("softmax")]),t._v("后经"),s("code",[t._v("1x1")]),t._v("卷积变成"),s("code",[t._v("left-top-right-bottom")]),t._v("的坐标，不过直接回归的结果是相对于特征图每个格的中心点在特征图尺度上的坐标值。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolov8_det1.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"关键点推理过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关键点推理过程"}},[t._v("#")]),t._v(" 关键点推理过程")]),t._v(" "),s("p",[t._v("关键点检测是在目标检测的输出头上加多一个分支，用来实现关键点的预测。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolov8_det_kpt.png",alt:""}})]),t._v(" "),s("p",[t._v("其中，"),s("code",[t._v("kpts_decode")]),t._v("的逻辑可以参考函数：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Pose")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("kpts_decode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kpts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""Decodes keypoints."""')]),t._v("\n    ndim "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kpt_shape"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# required for TFLite export to avoid 'PLACEHOLDER_FOR_GREATER_OP_CODES' bug")]),t._v("\n        y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" kpts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kpt_shape"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        a "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("anchors "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("strides\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ndim "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            a "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sigmoid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" kpts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clone"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ndim "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sigmoid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sigmoid (WARNING: inplace .sigmoid_() Apple MPS bug)")]),t._v("\n        y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ndim"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ndim"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("anchors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("strides\n        y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ndim"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("y"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ndim"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("anchors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("strides\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" y\n")])])]),s("p",[t._v("从上面的函数可以看出，关键点预测的坐标"),s("code",[t._v("x,y")]),t._v("是相对于特征图尺度对应"),s("code",[t._v("meshgrid")]),t._v("坐标点"),s("code",[t._v("left-top")]),t._v("距离的"),s("code",[t._v("1/2")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),s("p",[t._v("完整的部署工程可以参考"),s("a",{attrs:{href:"https://gitee.com/lx_r/object_detection_task/tree/main/detection/yolov8-ncnn",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://gitee.com/lx_r/object_detection_task/tree/main/detection/yolov8-ncnn"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" reference")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://github.com/pnnx/pnnx",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.https://github.com/pnnx/pnnx"),s("OutboundLink")],1),s("br"),t._v(" "),s("a",{attrs:{href:"https://github.com/Tencent/ncnn",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.https://github.com/Tencent/ncnn"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);