(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{382:function(t,s,a){"use strict";a.r(s);var n=a(17),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"旷视yolox算法介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#旷视yolox算法介绍"}},[t._v("#")]),t._v(" 旷视YOLOX算法介绍")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"http://arxiv.org/abs/2107.08430",target:"_blank",rel:"noopener noreferrer"}},[t._v("论文地址：http://arxiv.org/abs/2107.08430"),s("OutboundLink")],1),s("br"),s("br"),t._v(" "),s("a",{attrs:{href:"https://github.com/Megvii-BaseDetection/YOLOX",target:"_blank",rel:"noopener noreferrer"}},[t._v("代码：https://github.com/Megvii-BaseDetection/YOLOX"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"_1-简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[t._v("#")]),t._v(" 1.简介")]),t._v(" "),s("p",[t._v("2021年07月份，旷视的"),s("code",[t._v("Zheng Ze")]),t._v("与"),s("code",[t._v("Sonttao Liu")]),t._v("提交的论文中提出的"),s("code",[t._v("Anchor Free")]),t._v("检测算法。主要工作聚焦在"),s("code",[t._v("a decoupled head")]),t._v("和"),s("code",[t._v("label assigment strategy SimOTA")]),t._v("。作者使用"),s("code",[t._v("YOLOX")]),t._v("获得了2021年CVPR Autonomous Driving领域"),s("code",[t._v("Streaming Perception Challenge")]),t._v("的第一名"),s("a",{attrs:{href:"https://eval.ai/web/challenges/challenge-page/800/overview",target:"_blank",rel:"noopener noreferrer"}},[t._v("BaseDet"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("之前"),s("code",[t._v("YOLO")]),t._v("系列的论文自"),s("code",[t._v("YoloV1")]),t._v("后都是"),s("code",[t._v("Anchor Based")]),t._v("的，但自那之后如"),s("code",[t._v("CornerNet/CenterNet/FCOS")]),t._v("等"),s("code",[t._v("Anchor Free")]),t._v("的算法不断进步，"),s("code",[t._v("YoloX")]),t._v("的作者再次尝试将"),s("code",[t._v("Anchor Free")]),t._v("的算法技巧应用到"),s("code",[t._v("Yolo")]),t._v("算法上。作者认为"),s("code",[t._v("YoloV4/YoloV5")]),t._v("属于优化过度的"),s("code",[t._v("Anchor Based")]),t._v("算法，因此其提出的"),s("code",[t._v("YoloX")]),t._v("算法主要与"),s("code",[t._v("YoloV3")]),t._v("做比较。"),s("code",[t._v("YoloX")]),t._v("中的使用的"),s("code",[t._v("baseline")]),t._v("是"),s("code",[t._v("YoloV3-SPP")]),t._v(","),s("code",[t._v("YoloV3-SPP")]),t._v("中作者引入了"),s("code",[t._v("EMA")]),t._v("权值更新，"),s("code",[t._v("cosine lr schedule")]),t._v("等策略。")]),t._v(" "),s("h2",{attrs:{id:"_2-yolox所做的主要工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-yolox所做的主要工作"}},[t._v("#")]),t._v(" 2.YoloX所做的主要工作")]),t._v(" "),s("h3",{attrs:{id:"_2-1-分类-回归头解耦-decoupled-head"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-分类-回归头解耦-decoupled-head"}},[t._v("#")]),t._v(" 2.1 分类/回归头解耦(Decoupled head)")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("R-CNN")]),t._v("系列目标检测论文中，"),s("code",[t._v("bounding box")]),t._v("位置回归和物体类别判断都是分两个输出头来做的，而"),s("code",[t._v("Yolo")]),t._v("系列论文使用的"),s("code",[t._v("Yolo Head")]),t._v("都是在同个向量中通过共同的神经网络同时输出回归和类别信息。如下图"),s("a",{attrs:{href:"#1"}},[t._v("1")]),t._v(",在"),s("code",[t._v("YoloX")]),t._v("中作者重新使用了"),s("code",[t._v("Decoupled Head")]),t._v("，通过实验证明了其能提升检测的效果，")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolox1.jpg",alt:""}})]),t._v(" "),s("ul",[s("li",[t._v("1)加快收敛速度")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolox3.jpg",alt:""}})]),t._v(" "),s("ul",[s("li",[t._v("2)使用"),s("code",[t._v("NMS Free")]),t._v("做"),s("code",[t._v("End2End Yolo")]),t._v("时性能下降小。")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolox2.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"_2-2-simota"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-simota"}},[t._v("#")]),t._v(" 2.2 SimOTA")]),t._v(" "),s("p",[s("code",[t._v("Label Assignment")]),t._v("时目标检测中的关键点，以往多是基于"),s("code",[t._v("Max IoU")]),t._v("来实现"),s("code",[t._v("Anchor Box")]),t._v("正负标签的判定，属于基于先验知识的静态匹配方式，因一张图像中目标的数量是有限的，因此会将大量的"),s("code",[t._v("Anchor")]),t._v("判定为"),s("code",[t._v("negative")]),t._v(",造成严重的类别不平衡问题。"),s("a",{attrs:{href:"https://foobarweb.net/2022/09/25/8atss/",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("ATSS")]),s("OutboundLink")],1),t._v("提出了自适应训练样本采样算法，自适应确定判断"),s("code",[t._v("Anchor")]),t._v("正负标签的"),s("code",[t._v("IoU")]),t._v("阈值。"),s("code",[t._v("Label Assignment")]),t._v("问题是结合"),s("code",[t._v("Ground Truth Boxes")]),t._v("给每个"),s("code",[t._v("Anchor Box")]),t._v("分配类别，然后得到全局最优的结果，这个问题正好满足二分图优化的模型，因此也有不少工作是基于"),s("a",{attrs:{href:"https://blog.csdn.net/lx_ros/article/details/123980953",target:"_blank",rel:"noopener noreferrer"}},[t._v("匈牙利算法"),s("OutboundLink")],1),t._v("，最优路经传输("),s("code",[t._v("Optimal transport assignment")]),t._v(")来做的。"),s("a",{attrs:{href:"https://arxiv.org/abs/2103.14259",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("OTA")]),s("OutboundLink")],1),t._v("是"),s("code",[t._v("YoloX")]),t._v("作者"),s("code",[t._v("2021年04")]),t._v("月提交的论文中提出的方法，实现"),s("code",[t._v("label")]),t._v("的动态匹配。")]),t._v(" "),s("p",[s("code",[t._v("advanced label assignment")]),t._v("的四个要点")]),t._v(" "),s("ul",[s("li",[t._v("1）loss/quality aware")]),t._v(" "),s("li",[t._v("2）center prior")]),t._v(" "),s("li",[t._v("3）dynamic number of positive anchors")]),t._v(" "),s("li",[t._v("4） global view")])]),t._v(" "),s("p",[s("code",[t._v("YoloX")]),t._v("作者指出通过"),s("code",[t._v("Sinkhorn-Knopp")]),t._v("算法求解"),s("code",[t._v("OTA")]),t._v("问题增加了约"),s("code",[t._v("25%")]),t._v("的训练时间，因此在"),s("code",[t._v("YoloX")]),t._v("中使用被称为"),s("code",[t._v("SimOTA")]),t._v("的"),s("code",[t._v("dynamic top-K")]),t._v("算法求近似解。")]),t._v(" "),s("p",[t._v("SimOTA算法流程：")]),t._v(" "),s("ul",[s("li",[t._v("1）先对每个"),s("code",[t._v("prediction-gt pair")]),t._v("计算代价"),s("code",[t._v("cost")])])]),t._v(" "),s("mjx-container",{staticClass:"MathJax",staticStyle:{direction:"ltr",display:"block","text-align":"center",margin:"1em 0",position:"relative"},attrs:{jax:"SVG",display:"true"}},[s("svg",{staticStyle:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.991ex"},attrs:{xmlns:"http://www.w3.org/2000/svg",width:"20.062ex",height:"3.036ex",role:"img",focusable:"false",viewBox:"0 -903.7 8867.5 1341.8","aria-hidden":"true"}},[s("g",{attrs:{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"}},[s("g",{attrs:{"data-mml-node":"math"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D450",d:"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(433,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D45C",d:"M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(918,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D460",d:"M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"}})]),s("g",{attrs:{"data-mml-node":"msub",transform:"translate(1387,0)"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D461",d:"M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"}})]),s("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(394,-150) scale(0.707)","data-mjx-texclass":"ORD"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D456",d:"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(345,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D457",d:"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"}})])])]),s("g",{attrs:{"data-mml-node":"mo",transform:"translate(2644.1,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"3D",d:"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"}})]),s("g",{attrs:{"data-mml-node":"msubsup",transform:"translate(3699.8,0)"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D43F",d:"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"}})]),s("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(714,413) scale(0.707)","data-mjx-texclass":"ORD"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D450",d:"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(433,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D459",d:"M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(731,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D460",d:"M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"}})])]),s("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(714,-247) scale(0.707)","data-mjx-texclass":"ORD"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D456",d:"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(345,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D457",d:"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"}})])])]),s("g",{attrs:{"data-mml-node":"mo",transform:"translate(5534.6,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"2B",d:"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(6534.8,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D706",d:"M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"}})]),s("g",{attrs:{"data-mml-node":"msubsup",transform:"translate(7117.8,0)"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D43F",d:"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"}})]),s("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(714,498.6) scale(0.707)","data-mjx-texclass":"ORD"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D45F",d:"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(451,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D452",d:"M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(917,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D454",d:"M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"}})])]),s("g",{attrs:{"data-mml-node":"TeXAtom",transform:"translate(714,-293.8) scale(0.707)","data-mjx-texclass":"ORD"}},[s("g",{attrs:{"data-mml-node":"mi"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D456",d:"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"}})]),s("g",{attrs:{"data-mml-node":"mi",transform:"translate(345,0)"}},[s("path",{staticStyle:{"stroke-width":"3"},attrs:{"data-c":"1D457",d:"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"}})])])])])])]),s("mjx-assistive-mml",{staticStyle:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",overflow:"hidden",width:"100%"},attrs:{unselectable:"on",display:"block"}},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[s("mi",[t._v("c")]),s("mi",[t._v("o")]),s("mi",[t._v("s")]),s("msub",[s("mi",[t._v("t")]),s("mrow",{attrs:{"data-mjx-texclass":"ORD"}},[s("mi",[t._v("i")]),s("mi",[t._v("j")])],1)],1),s("mo",[t._v("=")]),s("msubsup",[s("mi",[t._v("L")]),s("mrow",{attrs:{"data-mjx-texclass":"ORD"}},[s("mi",[t._v("i")]),s("mi",[t._v("j")])],1),s("mrow",{attrs:{"data-mjx-texclass":"ORD"}},[s("mi",[t._v("c")]),s("mi",[t._v("l")]),s("mi",[t._v("s")])],1)],1),s("mo",[t._v("+")]),s("mi",[t._v("λ")]),s("msubsup",[s("mi",[t._v("L")]),s("mrow",{attrs:{"data-mjx-texclass":"ORD"}},[s("mi",[t._v("i")]),s("mi",[t._v("j")])],1),s("mrow",{attrs:{"data-mjx-texclass":"ORD"}},[s("mi",[t._v("r")]),s("mi",[t._v("e")]),s("mi",[t._v("g")])],1)],1)],1)],1)],1),s("ul",[s("li",[t._v("2）对每个"),s("mjx-container",{staticClass:"MathJax",attrs:{jax:"CHTML"}},[s("mjx-math",{staticClass:"MJX-TEX"},[s("mjx-msub",[s("mjx-mi",{staticClass:"mjx-i",attrs:{noIC:"true"}},[s("mjx-c",{attrs:{c:"g"}})],1),s("mjx-script",{staticStyle:{"vertical-align":"-0.15em"}},[s("mjx-mi",{staticClass:"mjx-i",attrs:{size:"s"}},[s("mjx-c",{attrs:{c:"i"}})],1)],1)],1)],1)],1),t._v("选择在一个中心范围内cost最小的"),s("code",[t._v("top k")]),t._v("个"),s("code",[t._v("prediction")]),t._v("作为"),s("code",[t._v("positive sample")]),t._v(",其余作为"),s("code",[t._v("negative samples")]),t._v(",超参数"),s("code",[t._v("k")]),t._v("对不同的"),s("code",[t._v("ground truth box")]),t._v("取不同的值，其选择见作者在"),s("a",{attrs:{href:"https://arxiv.org/abs/2103.14259",target:"_blank",rel:"noopener noreferrer"}},[t._v("OTA"),s("OutboundLink")],1),t._v("论文中的介绍和"),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/394392992",target:"_blank",rel:"noopener noreferrer"}},[t._v("这篇博客"),s("OutboundLink")],1),t._v("。")],1)]),t._v(" "),s("p",[s("strong",[t._v("源码分析")]),t._v(":")]),t._v(" "),s("p",[t._v("参考"),s("code",[t._v("mmdetection")]),t._v("中"),s("code",[t._v("SimOTA")]),t._v("的实现，见"),s("code",[t._v("mmdet/core/bbox/assigners/sim_ota_assigner.py")])]),t._v(" "),s("div",{staticClass:"language-mermaid extra-class"},[s("pre",{pre:!0,attrs:{class:"language-mermaid"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("graph")]),t._v(" TD\nA"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(1.先调用get_in_gt_and_in_center_info方法)")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" A1"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[1.1prior center是否落在gt bboxes中?]")]),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("A2"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[1.2prior center是否落在gt box centers附近center_radius*stride_x/y矩形内?]")]),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("B"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(2.初步判断priors哪些属于正样本is_in_gts_or_centers)")]),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("C"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(3.bbox_overlaps将2的正样本与gt boxes分别计算IoU得iou_cost)")]),t._v("\nB"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("D"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(4.binary_cross_entropy计算得cls_cost)")]),t._v("\n\nC"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("E"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(5.cost_matrix:shape,num_posxgt_box_nums)")]),t._v("\nD"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("E\n\nE"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("F"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(6.dynamic_k_matching得到每个positive_prior对应的gt_box)")]),t._v("\nF"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("G"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("(匹配完成)")]),t._v("\n")])])]),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SimOTAAssigner")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BaseAssigner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__init__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_assign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                gt_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                gt_bboxes_ignore"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                eps"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1e-7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""Assign gt to priors using SimOTA.\n        Args:\n            pred_scores (Tensor): Classification scores of one image,\n                a 2D-Tensor with shape [num_priors, num_classes]\n            priors (Tensor): All priors of one image, a 2D-Tensor with shape\n                [num_priors, 4] in [cx, xy, stride_w, stride_y] format.\n            decoded_bboxes (Tensor): Predicted bboxes, a 2D-Tensor with shape\n                [num_priors, 4] in [tl_x, tl_y, br_x, br_y] format.\n            gt_bboxes (Tensor): Ground truth bboxes of one image, a 2D-Tensor\n                with shape [num_gts, 4] in [tl_x, tl_y, br_x, br_y] format.\n            gt_labels (Tensor): Ground truth labels of one image, a Tensor\n                with shape [num_gts].\n            gt_bboxes_ignore (Tensor, optional): Ground truth bboxes that are\n                labelled as `ignored`, e.g., crowd boxes in COCO.\n            eps (float): A value added to the denominator for numerical\n                stability. Default 1e-7.\n        Returns:\n            :obj:`AssignResult`: The assigned result.\n        """')]),t._v("\n        INF "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100000.0")]),t._v("\n        num_gt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        num_bboxes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# assign 0 by default")]),t._v("\n        assigned_gt_inds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new_full"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                   dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" is_in_boxes_and_center "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_in_gt_and_in_center_info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        valid_decoded_bbox "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        valid_pred_scores "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        num_valid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" valid_decoded_bbox"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" num_gt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" num_bboxes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" num_valid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# No ground truth or boxes, return empty assignment")]),t._v("\n            max_overlaps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new_zeros"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" num_gt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# No truth, assign everything to background")]),t._v("\n                assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" gt_labels "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                assigned_labels "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                assigned_labels "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoded_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new_full"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                          dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" AssignResult"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" max_overlaps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" labels"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("assigned_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        pairwise_ious "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bbox_overlaps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("valid_decoded_bbox"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        iou_cost "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pairwise_ious "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" eps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        gt_onehot_label "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            F"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("one_hot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gt_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("int64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                      pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shape"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("float")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                          num_valid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        valid_pred_scores "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" valid_pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        cls_cost "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            F"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("binary_cross_entropy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                valid_pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("float32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sqrt_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                gt_onehot_label"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                reduction"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'none'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("valid_pred_scores"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        cost_matrix "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            cls_cost "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cls_weight "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" iou_cost "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("iou_weight "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("is_in_boxes_and_center"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" INF"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        matched_pred_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" matched_gt_inds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \\\n            self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dynamic_k_matching"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                cost_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pairwise_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# convert to AssignResult format")]),t._v("\n        assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" matched_gt_inds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        assigned_labels "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new_full"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        assigned_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("matched_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("long")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        max_overlaps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new_full"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("INF"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                 dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("float32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        max_overlaps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" matched_pred_ious\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" AssignResult"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" assigned_gt_inds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" max_overlaps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" labels"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("assigned_labels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_in_gt_and_in_center_info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        num_gt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        repeated_x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        repeated_y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        repeated_stride_x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        repeated_stride_y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" priors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("unsqueeze"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repeat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# is prior centers in gt bboxes, shape: [n_prior, n_gt]")]),t._v("\n        l_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repeated_x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        t_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repeated_y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        r_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" repeated_x\n        b_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" repeated_y\n\n        deltas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("l_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" r_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        is_in_gts "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" deltas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("values "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n        is_in_gts_all "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" is_in_gts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# is prior centers in gt centers")]),t._v("\n        gt_cxs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("\n        gt_cys "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" gt_bboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("\n        ct_box_l "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_cxs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("center_radius "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" repeated_stride_x\n        ct_box_t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_cys "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("center_radius "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" repeated_stride_y\n        ct_box_r "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_cxs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("center_radius "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" repeated_stride_x\n        ct_box_b "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gt_cys "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("center_radius "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" repeated_stride_y\n\n        cl_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repeated_x "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" ct_box_l\n        ct_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repeated_y "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" ct_box_t\n        cr_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ct_box_r "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" repeated_x\n        cb_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ct_box_b "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" repeated_y\n\n        ct_deltas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("cl_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ct_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cr_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cb_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        is_in_cts "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ct_deltas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("values "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n        is_in_cts_all "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" is_in_cts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# in boxes or in centers, shape: [num_priors]")]),t._v("\n        is_in_gts_or_centers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" is_in_gts_all "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" is_in_cts_all\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# both in boxes and centers, shape: [num_fg, num_gt]")]),t._v("\n        is_in_boxes_and_centers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            is_in_gts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("is_in_gts_or_centers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" is_in_cts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("is_in_gts_or_centers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" is_in_gts_or_centers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" is_in_boxes_and_centers\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dynamic_k_matching")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pairwise_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        matching_matrix "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("zeros_like"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dtype"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uint8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# select candidate topk ious for dynamic-k calculation")]),t._v("\n        candidate_topk "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("candidate_topk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pairwise_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# topk_ious shape: candidate_topk x num_gts")]),t._v("\n        topk_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("topk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pairwise_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" candidate_topk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# calculate dynamic k for each gt")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dynamic_ks shape: 1 x num_gts")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dynamic k正是基于最少`candidate_topk`个iou求和计算出来的，因此是dynamic的")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 每个 gt对应的topk是不一样的")]),t._v("\n        dynamic_ks "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clamp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topk_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" gt_idx "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("range")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_gt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pos_idx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("topk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                cost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gt_idx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" k"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dynamic_ks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("gt_idx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" largest"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gt_idx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pos_idx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        以上生成的`matching_matrix`有可能1个`prior`对应多个`gt_boxes`,还需以下处理\n        从1个`prior`对应的多个`gt_boxes`选`cost`最小的那个作为`gt_box`\n        """')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("del")]),t._v(" topk_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dynamic_ks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pos_idx\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# prior_match_gt_mask shape like (num_priors,)")]),t._v("\n        prior_match_gt_mask "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" prior_match_gt_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            cost_min"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cost_argmin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                cost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("prior_match_gt_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dim"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("prior_match_gt_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n            matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("prior_match_gt_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cost_argmin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# get foreground mask inside box and center prior")]),t._v("\n        fg_mask_inboxes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n        valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("valid_mask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clone"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fg_mask_inboxes\n\n        matched_gt_inds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" matching_matrix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("fg_mask_inboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argmax"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        matched_pred_ious "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("matching_matrix "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n                             pairwise_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("sum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("fg_mask_inboxes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" matched_pred_ious"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" matched_gt_inds\n")])])]),s("h3",{attrs:{id:"_2-3-end2end-yolo-nms-free"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-end2end-yolo-nms-free"}},[t._v("#")]),t._v(" 2.3 End2End Yolo(NMS Free)")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("2020年12月")]),t._v("份，旷视的"),s("code",[t._v("Jianfeng Wang")]),t._v("等提交的论文"),s("a",{attrs:{href:"https://arxiv.org/abs/2012.03544",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("End-to-End Object Detection with Fully Convolutional Network")]),s("OutboundLink")],1),t._v("提出了不需要使用极大值抑制做后处理的检测方法，其改进了"),s("code",[t._v("label assigment")]),t._v(",将以往"),s("code",[t._v("one2many")]),t._v("的标签分配方式改成了"),s("code",[t._v("one2one")]),t._v("的方式，更多介绍可参考"),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/332281368",target:"_blank",rel:"noopener noreferrer"}},[t._v("论文作者知乎上的文章"),s("OutboundLink")],1),t._v("。"),s("code",[t._v("2021年01月")]),t._v("份阿里的"),s("code",[t._v("Qiang Zhou")]),t._v("等提交的论文"),s("code",[t._v("[Object Detection Made Simpler by Eliminating Heuristic NMS](https://arxiv.org/abs/2101.11782)")]),t._v("中也使用"),s("code",[t._v("one2one")]),t._v("的标签分配方式实现了"),s("code",[t._v("NMS Free")]),t._v("的目标检测算法，"),s("code",[t._v("YoloX")]),t._v("参考以上方法实现"),s("code",[t._v("End2End")]),t._v("训练得到如下表灰色的实验结果，可以看到对性能和准确率都有一定的影响:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yoloxend2end.jpg",alt:""}})]),t._v(" "),s("p",[t._v("最近聚焦在研究"),s("code",[t._v("label assignment")]),t._v("，因此这块"),s("code",[t._v("NMS Free")]),t._v("还没来得及看源码，先挖个坑。"),s("code",[t._v("NMS Free")]),t._v("其实也非常有意义，因为"),s("code",[t._v("NMS")]),t._v("存在，在边缘设备部署模型时，后处理部分不能像模型本身能放"),s("code",[t._v("NPU")]),t._v("上加速计算，故需在CPU上运算。")]),t._v(" "),s("h3",{attrs:{id:"_2-4-其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-其他"}},[t._v("#")]),t._v(" 2.4 其他")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("数据增强方法")])]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("Mosaic")]),t._v(":"),s("code",[t._v("YoloV5")]),t._v("作者在"),s("a",{attrs:{href:"https://github.com/ultralytics/yolov3",target:"_blank",rel:"noopener noreferrer"}},[t._v("ultralytics-YOLOv3"),s("OutboundLink")],1),t._v("中提出的")])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://arxiv.org/abs/1710.09412",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("MixUp")]),s("OutboundLink")],1),t._v("2018年"),s("code",[t._v("mixup: Beyond empirical risk minimization")]),t._v("论文中提出，最早用于图像分类，自"),s("a",{attrs:{href:"https://arxiv.org/abs/1902.04103",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("BoF")]),s("OutboundLink")],1),t._v("后用于目标检测的数据增强")])])])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolox4.jpg",alt:""}})]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Anchor Free")]),t._v(": 做法类似于"),s("a",{attrs:{href:"https://foobarweb.net/2022/09/22/7FCOSNet/#more",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("FCOS")]),s("OutboundLink")],1),t._v(",每个"),s("code",[t._v("feature map cell")]),t._v("只预测一个输出框，相当于"),s("code",[t._v("Anchor Number=1")]),t._v("。同时为了得到更多的正样本，将"),s("code",[t._v("Feature Map")]),t._v("上"),s("code",[t._v("cell")]),t._v("落在目标中心附近一定范围的点都当作正样本，即"),s("code",[t._v("Multiple Positive Sample")]),t._v("。")])]),t._v(" "),s("InArticleAdsense",{attrs:{"data-ad-client":"ca-pub-8685746128991385","data-ad-slot":"2974191661"}}),t._v(" "),s("h3",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),s("blockquote",[s("ul",[s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/392221567",target:"_blank",rel:"noopener noreferrer"}},[t._v("1.https://zhuanlan.zhihu.com/p/392221567"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/394392992",target:"_blank",rel:"noopener noreferrer"}},[t._v("2.https://zhuanlan.zhihu.com/p/394392992"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/397993315",target:"_blank",rel:"noopener noreferrer"}},[t._v("3.https://zhuanlan.zhihu.com/p/397993315"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/332281368",target:"_blank",rel:"noopener noreferrer"}},[t._v("4.丢弃Transformer，FCN也可以实现E2E检测"),s("OutboundLink")],1)])])])],1)}),[],!1,null,null,null);s.default=e.exports}}]);