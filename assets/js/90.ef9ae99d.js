(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{408:function(e,_,v){"use strict";v.r(_);var o=v(17),a=Object(o.a)({},(function(){var e=this,_=e._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h1",{attrs:{id:"mask-r-cnn-yolov8-rtmdet三种实例分割方法推理逻辑对比"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#mask-r-cnn-yolov8-rtmdet三种实例分割方法推理逻辑对比"}},[e._v("#")]),e._v(" Mask R-CNN/YOLOV8/RTMDET三种实例分割方法推理逻辑对比")]),e._v(" "),_("p",[e._v("实例分割是同时检测与分割，即在检测出检测框的同时分割出检测中的对象。这样，不仅实现了语义分割，同时区分出了同类别的不同的对象。")]),e._v(" "),_("p",[e._v("以"),_("code",[e._v("human")]),e._v("这个类别为例，")]),e._v(" "),_("p",[e._v("检测任务：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/inst1.jpg",alt:""}})]),e._v(" "),_("p",[e._v("分割任务：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/inst2.jpg",alt:""}})]),e._v(" "),_("p",[e._v("实例分割：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/inst3.jpg",alt:""}})]),e._v(" "),_("p",[e._v("从上面这个例子可以看出，检测任务定位了对象的包围框，语义分割分割出了人这个类别，不过把所有的人一起分割了，实例分割区分出了每个人，并分别进行了分割。")]),e._v(" "),_("p",[e._v("实际在做实例分割时，通常同时输出对象的检测框，并给出对象的分割结果。下面介绍三种常见的实例分割算法。")]),e._v(" "),_("h2",{attrs:{id:"mask-r-cnn"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#mask-r-cnn"}},[e._v("#")]),e._v(" Mask R-CNN")]),e._v(" "),_("p",[e._v("首先是"),_("code",[e._v("Mask R-CNN")]),e._v("，在目标检测中有介绍过"),_("code",[e._v("Mask RCNN")]),e._v("是"),_("code",[e._v("FAIR")]),e._v("的何凯明等于"),_("code",[e._v("2017")]),e._v("年"),_("code",[e._v("03")]),e._v("月提交的论文"),_("a",{attrs:{href:"https://arxiv.org/abs/1703.06870",target:"_blank",rel:"noopener noreferrer"}},[e._v("Mask R-CNN"),_("OutboundLink")],1),e._v("中提出的，该算法同时支持"),_("strong",[e._v("目标检测\\实例分割\\关键点检测的任务")]),e._v("。")]),e._v(" "),_("blockquote",[_("p",[e._v("论文:"),_("a",{attrs:{href:"https://arxiv.org/abs/1703.06870",target:"_blank",rel:"noopener noreferrer"}},[e._v("Mask R-CNN"),_("OutboundLink")],1),_("br"),_("br"),e._v("\n代码:"),_("a",{attrs:{href:"https://github.com/facebookresearch/detectron2.git",target:"_blank",rel:"noopener noreferrer"}},[e._v("detectron2"),_("OutboundLink")],1)])]),e._v(" "),_("p",[e._v("在这里，不再介绍"),_("code",[e._v("Mask RCNN")]),e._v("的"),_("code",[e._v("backbone")]),e._v("和"),_("code",[e._v("neck")]),e._v("部分，关于"),_("a",{attrs:{href:"https://foobarweb.net/cv/detection/rpn.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("RPN"),_("OutboundLink")],1),e._v("和"),_("a",{attrs:{href:"https://foobarweb.net/cv/detection/roi-pool-align.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("ROI Pooling"),_("OutboundLink")],1),e._v("的介绍可以参考之前的文章：")]),e._v(" "),_("blockquote",[_("p",[_("a",{attrs:{href:"https://foobarweb.net/cv/detection/roi-pool-align.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("1.ROI Pooling 与 ROI Align"),_("OutboundLink")],1),_("br"),e._v(" "),_("a",{attrs:{href:"https://foobarweb.net/cv/detection/rpn.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("2.Region Proposal Network"),_("OutboundLink")],1)])]),e._v(" "),_("p",[e._v("这里只讨论"),_("code",[e._v("RoI Pooling")]),e._v("后的"),_("code",[e._v("Head")]),e._v("部分，")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/mask_rcnn.png",alt:""}})]),e._v(" "),_("p",[_("code",[e._v("Mask R-CNN")]),e._v("同时支持输出检测框，实例分割结果，关键点，这里我们只讨论"),_("code",[e._v("Mask Head")]),e._v("部分，即上图中的右侧绿色分支。")]),e._v(" "),_("p",[e._v("值得注意的是，上图是粗略表示，关于"),_("code",[e._v("proposal")]),e._v("在"),_("code",[e._v("Head")]),e._v("中的使用和"),_("code",[e._v("Mask/Box/KeyPoint Head")]),e._v("之间的关系可以参考下面两个图。")]),e._v(" "),_("p",[e._v("在训练时，"),_("code",[e._v("Mask/KeyPoint Head")]),e._v("都使用"),_("code",[e._v("proposal")]),e._v("框来当作检测"),_("code",[e._v("box")]),e._v("框选对象，如下图蓝色线流所示：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/mask_rcnn1.png",alt:""}})]),e._v(" "),_("p",[e._v("在预测时，"),_("code",[e._v("Mask/KeyPoint Head")]),e._v("不再使用"),_("code",[e._v("proposals")]),e._v("转而使用"),_("code",[e._v("Box Head")]),e._v("预测的检测框来框选对象，因此"),_("code",[e._v("Mask/KeyPoint Head")]),e._v("依赖检测框的输出，如下图紫色线流所示意，")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/mask_rcnn2.png",alt:""}})]),e._v(" "),_("p",[_("code",[e._v("Mask R-CNN")]),e._v("的"),_("code",[e._v("Mask Head")]),e._v("分析如下，整理自"),_("code",[e._v("detectron2")]),e._v("代码库：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/mask_rcnn3.png",alt:""}})]),e._v(" "),_("p",[_("code",[e._v("Mask Head")]),e._v("的输入有两个，一个是"),_("code",[e._v("bounding boxes")]),e._v("或者"),_("code",[e._v("proposals")]),e._v("(测试推理时使用"),_("code",[e._v("boxes")]),e._v(",训练时使用RPN给出的"),_("code",[e._v("proposals")]),e._v("),另一个是"),_("code",[e._v("backbone")]),e._v("提取的"),_("code",[e._v("feature map")]),e._v("。")]),e._v(" "),_("p",[_("code",[e._v("Mask Head")]),e._v("的结构如上图，先是对"),_("code",[e._v("feature map")]),e._v("根据"),_("code",[e._v("bounding boxes")]),e._v("做"),_("code",[e._v("ROI Pooling")]),e._v(",得到每个"),_("code",[e._v("ROI")]),e._v("的特征图，然后是连续几层常规卷积，最后再跟一层转置卷积进行X2上采样，同时卷积输出通道变成"),_("code",[e._v("num_class")]),e._v("，得到的输出"),_("code",[e._v("shape=(B*N,num_class, 28, 28)")]),e._v("，这里"),_("code",[e._v("28x28")]),e._v("就是"),_("code",[e._v("ROI")]),e._v("区域对应的"),_("code",[e._v("mask")]),e._v(",这里对每个对象预测了"),_("code",[e._v("num_class")]),e._v("个"),_("code",[e._v("mask")]),e._v(",在"),_("code",[e._v("Mask R-CNN")]),e._v("中，直接使用"),_("code",[e._v("Box Head")]),e._v("预测的"),_("code",[e._v("label id")]),e._v("来取对应的"),_("code",[e._v("mask")]),e._v("并"),_("code",[e._v("sigmoid")]),e._v("以作为最终当前实例的分割结果。")]),e._v(" "),_("p",[e._v("转置卷积的介绍参考这里"),_("a",{attrs:{href:"https://foobarweb.net/ml/common/transconv.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("转置卷积"),_("OutboundLink")],1),e._v("。")]),e._v(" "),_("p",[e._v("得到"),_("code",[e._v("28X28")]),e._v("的实例ROI分割结果后，要将其变换到原图像上，这里使用了"),_("code",[e._v("grid_sample")]),e._v("方法，使用"),_("code",[e._v("grid_sample")]),e._v("变换，会根据"),_("code",[e._v("box")]),e._v("坐标将"),_("code",[e._v("ROI Mask")]),e._v("变换到原图像"),_("code",[e._v("box")]),e._v("所处的区域。变换后再根据超参数阈值对"),_("code",[e._v("mask")]),e._v("做二值化即可得到最后的分割结果。")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/mask_rcnn4.png",alt:""}})]),e._v(" "),_("p",[_("strong",[e._v("后记")]),e._v("： 这里有个疑问，所有的"),_("code",[e._v("ROI")]),e._v("无论大小都使用了同样大小尺寸的"),_("code",[e._v("ROI Feature Map")]),e._v("都是"),_("code",[e._v("28x28")]),e._v(",但是正常难道不应该对大目标使用大尺寸，小目标使用小尺寸吗？")]),e._v(" "),_("h2",{attrs:{id:"yolov5-8实例分割方法"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#yolov5-8实例分割方法"}},[e._v("#")]),e._v(" YOLOV5/8实例分割方法")]),e._v(" "),_("p",[e._v("YOLOV5/8中使用的"),_("code",[e._v("Instance")]),e._v("分割方法和"),_("code",[e._v("Mask RCNN")]),e._v("中区别比较大，")]),e._v(" "),_("p",[e._v("其利用"),_("code",[e._v("Head1")]),e._v("中尺寸最大的特征图作为"),_("code",[e._v("Mask")]),e._v("分支的输入，经过"),_("code",[e._v("proto_pred")]),e._v("卷积层的处理得到"),_("code",[e._v("shape:(B, mask_channel, H, W)")]),e._v("的"),_("code",[e._v("mask_feature")]),e._v("。")]),e._v(" "),_("p",[e._v("检测框的预测分支和目标检测中的"),_("code",[e._v("YoloV5 Head")]),e._v("基本相同，除了对于"),_("code",[e._v("feature_map")]),e._v("的通道上增加了计算每个实例掩码用的参数，参数的数量同"),_("code",[e._v("proto_pred")]),e._v("输出的"),_("code",[e._v("mask_channel")]),e._v("，所以对于"),_("code",[e._v("80X80/40X40/20X20")]),e._v("的"),_("code",[e._v("feature_map")]),e._v("，其通道数为: "),_("code",[e._v("4 + 1 + num_classes + mask_channel")])]),e._v(" "),_("p",[e._v("拿到解码后的检测框，经过"),_("code",[e._v("nms")]),e._v("处理后得到最后的检测框,取对应的"),_("code",[e._v("mask_channel")]),e._v("个"),_("code",[e._v("coeffs")]),e._v("和"),_("code",[e._v("mask_feature")]),e._v("相乘加权即可得到最后的实例分割结果，完整过程如下图：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/yolov51.png",alt:""}})]),e._v(" "),_("h2",{attrs:{id:"rtmdet中的实例分割"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#rtmdet中的实例分割"}},[e._v("#")]),e._v(" RTMDet中的实例分割")]),e._v(" "),_("p",[_("code",[e._v("RTMDet")]),e._v("中和"),_("code",[e._v("YOLOV5")]),e._v("处理方式很相似，都是对每个检测框实例计算坐标时同时给出预测"),_("code",[e._v("mask")]),e._v("所需的权重参数，区别在与"),_("code",[e._v("YOLOV5/8")]),e._v("中直接用参数和"),_("code",[e._v("mask_feature")]),e._v("进行加权求和，而"),_("code",[e._v("RTMDET")]),e._v("预测了"),_("code",[e._v("169")]),e._v("个参数，构造了"),_("code",[e._v("3")]),e._v("层卷积，来和"),_("code",[e._v("mask_feature")]),e._v("运算得到分割"),_("code",[e._v("mask")]),e._v("。")]),e._v(" "),_("p",[e._v("还有一点"),_("code",[e._v("RTMDet")]),e._v("中"),_("code",[e._v("mask_feature")]),e._v(" 并非只使用了"),_("code",[e._v("80X80")]),e._v("的"),_("code",[e._v("feature map")]),e._v(",它还将其余两个头上的特征图上采样后与其进行"),_("code",[e._v("concatenate")]),e._v("，输入"),_("code",[e._v("mask_feature")]),e._v("分支后得到"),_("code",[e._v("Batch_SizeX8X80X80")]),e._v("的"),_("code",[e._v("mask")]),e._v("特征图。特征图并不能直接用来和"),_("code",[e._v("predicted kernel")]),e._v("卷积得到"),_("code",[e._v("Instance Mask")]),e._v(","),_("code",[e._v("RTMDet")]),e._v("算法使用的"),_("code",[e._v("mask feat")]),e._v("先重复了检测实例的个数次，然后合并了检测框在特征图上的坐标，最后与"),_("code",[e._v("predicted kernel")]),e._v("做卷积的输入"),_("code",[e._v("mask")]),e._v("特征图变成了"),_("code",[e._v("(N,10,80,80)")]),e._v("。")]),e._v(" "),_("p",[_("code",[e._v("RTMDet")]),e._v("实例分割推理的完整过程可参考下图，")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/RTMDet.png",alt:""}})]),e._v(" "),_("p",[_("code",[e._v("RTMDet")]),e._v("根据"),_("code",[e._v("predicted_kernel")]),e._v("升成卷积的方法被称为动态卷积"),_("code",[e._v("Dynamic Convolution")]),e._v(",如下图，")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://day-pic-1311699660.cos.ap-nanjing.myqcloud.com/image/RTMDet1.png",alt:""}})]),e._v(" "),_("p",[e._v("如上，就是"),_("code",[e._v("Mask R-CNN/YOLOV8/RTMDet")]),e._v("三种实例分割的方法，总结来看，"),_("code",[e._v("YOLOV8/RTMDet")]),e._v("方法相似，"),_("code",[e._v("RTMDet")]),e._v("处理"),_("code",[e._v("mask")]),e._v("预测的方法更复杂一些，"),_("code",[e._v("YOLOV8")]),e._v("中的加权求和变成了三层卷积,输入的特征图重复了"),_("code",[e._v("num_instance")]),e._v("次，并合并了"),_("code",[e._v("mask_feature")]),e._v("上对应的"),_("code",[e._v("priors")]),e._v("和"),_("code",[e._v("num_instance")]),e._v("对应点的相对坐标。"),_("code",[e._v("YOLOV8/RTMDet")]),e._v("输出"),_("code",[e._v("Instance Mask")]),e._v("的分辨率比"),_("code",[e._v("Mask RCNN")]),e._v("要大，"),_("code",[e._v("Mask RCNN")]),e._v("经过转置卷积上采样后输出的"),_("code",[e._v("RoI")]),e._v("分割图的大小是"),_("code",[e._v("28X28")]),e._v(",经过"),_("code",[e._v("GridSample")]),e._v("后还原到原分辨率上。不过"),_("code",[e._v("Mask R-CNN")]),e._v("输出的是"),_("code",[e._v("RoI")]),e._v("的分割图，而"),_("code",[e._v("YOLOV8/RTMDet")]),e._v("输出的是在整幅图像上的分割图。")]),e._v(" "),_("blockquote",[_("p",[_("a",{attrs:{href:"https://github.com/ultralytics/ultralytics.git",target:"_blank",rel:"noopener noreferrer"}},[e._v("1.https://github.com/ultralytics/ultralytics.git"),_("OutboundLink")],1)])]),e._v(" "),_("blockquote",[_("p",[_("a",{attrs:{href:"https://arxiv.org/abs/2212.07784",target:"_blank",rel:"noopener noreferrer"}},[e._v("2.https://arxiv.org/abs/2212.07784"),_("OutboundLink")],1)])]),e._v(" "),_("blockquote",[_("p",[_("a",{attrs:{href:"https://github.com/facebookresearch/detectron2.git",target:"_blank",rel:"noopener noreferrer"}},[e._v("3.https://github.com/facebookresearch/detectron2.git"),_("OutboundLink")],1)])])])}),[],!1,null,null,null);_.default=a.exports}}]);